<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SUCH IS LIFE - Kelly Gang Survival</title>
    <style>
        body { margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #5D4037; font-family: 'Courier New', monospace; color: #FFD700; }
        #game-container { background-color: #3E2723; border: 5px solid #D2691E; border-radius: 15px; padding: 20px; text-align: center; max-width: 900px; width: 100%; position: relative; }
        #game-canvas { border: 3px solid #D2691E; margin: 20px 0; background-color: #8B4513; }
        button { background-color: #D2691E; color: white; border: none; padding: 10px 20px; margin: 10px; cursor: pointer; font-family: 'Courier New', monospace; }
        button:hover { background-color: #FF4500; }
        #game-status { min-height: 30px; color: #FFD700; }
        #connection-section input { padding: 10px; margin: 10px; width: 200px; }
        #player-stats { position: absolute; top: 30px; left: 30px; color: white; font-size: 16px; background: rgba(0, 0, 0, 0.7); padding: 10px; border-radius: 5px; }
        #game-over-screen { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(0, 0, 0, 0.8); padding: 20px; border: 3px solid #D2691E; border-radius: 10px; color: #FFD700; text-align: center; }
        #countdown { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 48px; color: red; text-shadow: 2px 2px 4px black; }
    </style>
</head>
<body>
    <div id="game-container">
        <h1 style="color: red;">SUCH IS LIFE</h1>
        <div id="connection-section">
            <button onclick="createGame()">Create Game</button>
            <div>
                <input type="text" id="gameIdInput" placeholder="Enter Game ID">
                <button onclick="joinGame()">Join Game</button>
            </div>
        </div>
        <div id="game-status"></div>
        <div id="player-stats"></div>
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        <div id="countdown"></div>
        <div id="game-over-screen">
            <h2>Game Over, Mate!</h2>
            <div id="final-stats"></div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let socket;
        let gameState = { gameId: null, playerId: null, players: {}, enemies: [], bullets: [], power_ups: [], score: 0, level: 1, game_over: false, countdown: 0, is_night: false };
        const CANVAS_WIDTH = 800;
        const CANVAS_HEIGHT = 600;
        let keys = {};
        let lastShotTime = 0;
        const SHOOT_COOLDOWN = 200;

        function createGame() {
            socket = new WebSocket('wss://such-is-life.glitch.me');
            setupSocketHandlers();
            socket.onopen = () => { socket.send(JSON.stringify({ type: 'create_game' })); };
        }

        function joinGame() {
            const gameId = document.getElementById('gameIdInput').value.toUpperCase();
            socket = new WebSocket('wss://such-is-life.glitch.me');
            setupSocketHandlers();
            socket.onopen = () => { socket.send(JSON.stringify({ type: 'join_game', game_id: gameId })); };
        }

        function setupSocketHandlers() {
            socket.onmessage = handleServerMessage;
            socket.onerror = (error) => { updateStatus('Connection error'); };
            socket.onclose = () => { updateStatus('Disconnected'); };
        }

        function handleServerMessage(event) {
            const data = JSON.parse(event.data);
            switch (data.type) {
                case 'game_created':
                    gameState.gameId = data.game_id;
                    gameState.playerId = data.player_id;
                    updateStatus(`Game created! ID: ${data.game_id}`);
                    setupGameControls();
                    break;
                case 'game_joined':
                    gameState.gameId = data.game_id;
                    gameState.playerId = data.player_id;
                    updateStatus(`Joined game: ${data.game_id}`);
                    setupGameControls();
                    break;
                case 'game_state':
                    gameState.players = data.state.players;
                    gameState.enemies = data.state.enemies;
                    gameState.bullets = data.state.bullets;
                    gameState.power_ups = data.state.power_ups;
                    gameState.score = data.state.score;
                    gameState.level = data.state.level;
                    gameState.game_over = data.state.game_over;
                    gameState.countdown = data.state.countdown;
                    gameState.is_night = data.state.is_night;
                    if (gameState.game_over) showGameOver(data.state.final_stats);
                    updatePlayerStats();
                    break;
                case 'error':
                    updateStatus(data.message);
                    break;
            }
        }

        function setupGameControls() {
            document.addEventListener('keydown', (e) => { if (!gameState.game_over && gameState.countdown <= 0) keys[e.key] = true; });
            document.addEventListener('keyup', (e) => { keys[e.key] = false; });
            startGameLoop();
        }

        function handlePlayerMovement() {
            if (!gameState.playerId || gameState.game_over || gameState.countdown > 0) return;
            const player = gameState.players[gameState.playerId];
            if (!player) return;

            const newPosition = { ...player.position };
            const speed = player.speed;
            if (keys['w']) newPosition.y = Math.max(0, newPosition.y - speed);
            if (keys['s']) newPosition.y = Math.min(CANVAS_HEIGHT - 20, newPosition.y + speed);
            if (keys['a']) newPosition.x = Math.max(0, newPosition.x - speed);
            if (keys['d']) newPosition.x = Math.min(CANVAS_WIDTH - 20, newPosition.x + speed);

            if (newPosition.x !== player.position.x || newPosition.y !== player.position.y) {
                socket.send(JSON.stringify({ type: 'player_move', game_id: gameState.gameId, player_id: gameState.playerId, position: newPosition }));
            }

            const currentTime = Date.now();
            let direction;
            if (keys['ArrowUp']) direction = 'up';
            else if (keys['ArrowDown']) direction = 'down';
            else if (keys['ArrowLeft']) direction = 'left';
            else if (keys['ArrowRight']) direction = 'right';
            if (direction && currentTime - lastShotTime >= SHOOT_COOLDOWN) {
                socket.send(JSON.stringify({ type: 'player_shoot', game_id: gameState.gameId, player_id: gameState.playerId, direction: direction }));
                lastShotTime = currentTime;
            }
        }

        function startGameLoop() {
            function gameLoop() {
                if (!gameState.game_over) {
                    ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

                    Object.entries(gameState.players).forEach(([id, player]) => {
                        ctx.fillStyle = id === gameState.playerId ? 'red' : 'blue';
                        ctx.fillRect(player.position.x, player.position.y, 20, 20);
                    });

                    gameState.enemies.forEach(enemy => {
                        ctx.fillStyle = 'green';
                        ctx.fillRect(enemy.position.x, enemy.position.y, 30, 30);
                    });

                    gameState.bullets.forEach(bullet => {
                        ctx.fillStyle = bullet.source === 'player' ? 'yellow' : 'white';
                        ctx.beginPath();
                        ctx.arc(bullet.position.x, bullet.position.y, 5, 0, Math.PI * 2);
                        ctx.fill();
                    });

                    gameState.power_ups.forEach(power_up => {
                        ctx.fillStyle = 'cyan';
                        ctx.fillRect(power_up.position.x, power_up.position.y, 10, 10);
                    });

                    ctx.fillStyle = 'white';
                    ctx.font = '20px Courier New';
                    ctx.fillText(`Score: ${gameState.score}  Level: ${gameState.level}`, 10, 30);

                    if (gameState.countdown > 0) {
                        document.getElementById('countdown').textContent = Math.ceil(gameState.countdown);
                    } else {
                        document.getElementById('countdown').textContent = gameState.is_night ? 'Night' : 'Day';
                    }

                    if (gameState.is_night) {
                        ctx.fillStyle = 'rgba(0, 0, 50, 0.5)';
                        ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
                    }
                }
                handlePlayerMovement();
                requestAnimationFrame(gameLoop);
            }
            gameLoop();
        }

        function updatePlayerStats() {
            const player = gameState.players[gameState.playerId];
            if (player) {
                document.getElementById('player-stats').innerHTML = `
                    Health: ${player.health}<br>
                    Armor: ${player.armor}<br>
                    Gun: ${player.gun}<br>
                    Speed: ${player.speed}<br>
                    Kills: ${player.kills}
                `;
            }
        }

        function showGameOver(stats) {
            document.getElementById('final-stats').innerHTML = `
                Final Score: ${stats.score}<br>
                Time Survived: ${stats.time_survived} seconds<br>
                Kills:<br>
                ${Object.entries(stats.players).map(([id, kills]) => `${id === gameState.playerId ? 'You' : 'Mate'}: ${kills}`).join('<br>')}
            `;
            document.getElementById('game-over-screen').style.display = 'block';
        }

        function updateStatus(message) {
            document.getElementById('game-status').textContent = message;
        }
    </script>
</body>
</html>
