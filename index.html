<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SUCH IS LIFE - Kelly Gang Survival</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* --- (Keep your existing CSS rules - they define the look) --- */
        :root {
            --bg-color: #3E2723; --primary-color: #D2691E; --secondary-color: #8B4513;
            --accent-color: #FFD700; --text-color: #FFF8DC; --player-color: #DC143C;
            --other-player-color: #4682B4; --enemy-color: #2E8B57; --bullet-player-color: #FFEB3B;
            --bullet-enemy-color: #FFFFFF; --health-bar-bg: #555; --health-bar-high: #4CAF50;
            --health-bar-medium: #FFC107; --health-bar-low: #F44336; --powerup-health: #00FF00;
            --powerup-gun: #FF00FF; --powerup-speed: #00FFFF; --powerup-armor: #C0C0C0;
            --night-overlay: rgba(0, 0, 50, 0.4); --font-family: 'Courier New', monospace;
        }
        body { margin: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; background-color: var(--bg-color); font-family: var(--font-family); color: var(--text-color); }
        #game-container { background-color: var(--secondary-color); border: 5px solid var(--primary-color); border-radius: 15px; padding: 20px; text-align: center; max-width: 900px; width: calc(100% - 40px); position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        h1 { color: var(--player-color); margin-top: 0; text-shadow: 2px 2px 4px black; }

        /* --- Visibility Control --- */
        #mode-selection-section, #join-code-section, #waiting-section, #game-area, #game-over-screen {
            display: none; /* Hide all sections by default */
        }
        /* JS will set display: 'block' or 'flex' for the active section */

        #game-status { min-height: 25px; color: var(--accent-color); font-weight: bold; margin-bottom: 15px; }
        button { background-color: var(--primary-color); color: white; border: 2px solid var(--bg-color); padding: 10px 20px; margin: 10px 5px; cursor: pointer; font-family: var(--font-family); font-size: 1rem; transition: background-color 0.2s ease; border-radius: 5px; }
        button:hover:not(:disabled) { background-color: #FF4500; } button:disabled { background-color: #777; cursor: not-allowed; }
        input[type="text"] { padding: 10px; margin: 10px 5px; width: 180px; font-family: var(--font-family); font-size: 1rem; border: 2px solid var(--primary-color); border-radius: 5px; background-color: var(--text-color); color: var(--bg-color); text-transform: uppercase; } /* Uppercase for game code */

        #game-canvas { border: 3px solid var(--primary-color); background-color: #A0522D; display: block; margin: 10px auto 10px; max-width: 100%; height: auto; } /* Adjusted margin */
        #hud { display: flex; justify-content: space-between; align-items: flex-start; margin-top: 5px; padding: 0 10px; }
        #player-stats { color: var(--text-color); font-size: 14px; background: rgba(0, 0, 0, 0.6); padding: 8px 12px; border-radius: 5px; text-align: left; border: 1px solid var(--accent-color); }
        #player-stats span { display: inline-block; min-width: 50px; font-weight: bold; }
        #game-info { color: var(--text-color); font-size: 18px; background: rgba(0, 0, 0, 0.6); padding: 8px 12px; border-radius: 5px; text-align: right; border: 1px solid var(--accent-color); }
        #chat-section { display: flex; margin-top: 10px; align-items: center; flex-wrap: wrap; } /* Allow wrap */
        #chatInput { flex-grow: 1; margin-right: 5px; min-width: 200px; } /* Min width for input */
        #chat-log { height: 80px; overflow-y: scroll; border: 1px solid var(--primary-color); margin-top: 5px; padding: 5px; text-align: left; background: rgba(0,0,0,0.3); font-size: 13px; border-radius: 5px; flex-basis: 100%; order: 3; } /* Full width, below input */
        #chat-log div { margin-bottom: 3px; }
        #chat-log .my-message { color: var(--bullet-player-color); } #chat-log .other-message { color: var(--text-color); } #chat-log .system-message { color: var(--accent-color); font-style: italic; }
        #countdown { position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%); font-size: 72px; color: var(--player-color); text-shadow: 3px 3px 6px black; z-index: 10; pointer-events: none; display: none; }
        #day-night-indicator { position: absolute; top: 10px; right: 10px; font-size: 18px; color: var(--text-color); background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 5px; z-index: 5; display: none; }
        #game-over-screen { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(0, 0, 0, 0.85); padding: 30px; border: 3px solid var(--player-color); border-radius: 10px; color: var(--accent-color); text-align: center; z-index: 20; width: 80%; max-width: 500px; display: none; } /* Ensure initially hidden */
        #game-over-screen h2 { color: var(--player-color); margin-top: 0;}
        #final-stats { margin-bottom: 20px; text-align: left; } #final-stats strong { color: white; }

        /* --- NEW Waiting Section Styles --- */
        #waiting-section { padding: 20px; border: 2px dashed var(--primary-color); margin-top: 15px; background-color: rgba(0,0,0,0.2); border-radius: 8px; }
        #waiting-section p { font-size: 1.1rem; margin-bottom: 10px;}
        #game-code-display { font-size: 1.8rem; font-weight: bold; color: var(--accent-color); background-color: var(--bg-color); padding: 5px 15px; border-radius: 5px; display: inline-block; margin: 10px 0; user-select: all; /* Allow easy copying */ }

    </style>
</head>
<body>
    <div id="game-container">
        <h1>SUCH IS LIFE</h1>

        <div id="game-status">Initializing...</div>

        <!-- NEW: Mode Selection -->
        <div id="mode-selection-section">
            <p>How do you want to play?</p>
            <button id="playFriendBtn" onclick="createFriendGame()">Play a Friend (Get Code)</button>
            <button id="showJoinCodeBtn" onclick="showJoinUI()">Join Friend's Game (Enter Code)</button>
            <!-- <button disabled>Play Computer (Soon!)</button> -->
            <!-- <button disabled>Random Match (Soon!)</button> -->
        </div>

        <!-- NEW: Join Code Input -->
        <div id="join-code-section">
             <p>Enter the 6-character game code:</p>
             <input type="text" id="gameIdInput" placeholder="ABCDEF" maxlength="6">
             <button id="joinGameBtn" onclick="joinGame()">Join Game</button>
             <button onclick="showModeSelection()">Back</button>
        </div>

        <!-- NEW: Waiting for Opponent -->
        <div id="waiting-section">
             <p>Game created! Share this code with your friend:</p>
             <div id="game-code-display">------</div>
             <p id="waiting-message">Waiting for opponent to join...</p>
             <button onclick="resetToConnection(true)">Cancel Game</button>
             <!-- Game canvas might be shown here eventually -->
             <canvas id="waitingCanvas" width="800" height="600" style="display: none; border: 3px solid var(--primary-color); background-color: #A0522D; margin: 10px auto;"></canvas>
        </div>

        <!-- Main Game Area -->
        <div id="game-area">
            <div style="position: relative;">
                <canvas id="gameCanvas" width="800" height="600"></canvas>
                <div id="countdown"></div>
                <div id="day-night-indicator">Day</div>
            </div>
            <div id="hud">
                 <div id="player-stats">Loading...</div>
                 <div id="game-info">Score: 0 | Level: 1</div>
            </div>
             <div id="chat-section">
                 <input type="text" id="chatInput" placeholder="Say somethin', mate..." maxlength="50">
                 <button id="sendChatBtn" onclick="sendChatMessage()">Send</button>
                 <div id="chat-log"></div>
             </div>
             <!-- Optional button to leave game? -->
             <button onclick="resetToConnection(true)">Leave Game</button>
        </div>

        <!-- Game Over Screen -->
        <div id="game-over-screen">
            <h2>Game Over, Mate!</h2>
            <div id="final-stats"></div>
            <button onclick="resetToConnection(false)">Back to Menu</button> <!-- Don't force close socket here -->
        </div>

    </div>

    <script>
        // --- Constants ---
        const WEBSOCKET_URL = 'wss://such-is-life.glitch.me/ws'; // CORRECT PATH
        // --- (Keep other constants: CANVAS_WIDTH, PLAYER_WIDTH, COLORS etc.) ---
        const CANVAS_WIDTH = 800; const CANVAS_HEIGHT = 600; const PLAYER_WIDTH = 20; const PLAYER_HEIGHT = 20;
        const ENEMY_WIDTH = 25; const ENEMY_HEIGHT = 25; const BULLET_RADIUS = 4; const POWERUP_SIZE = 12;
        const SHOOT_COOLDOWN = 200; const CHAT_MESSAGE_DURATION = 8;

        // --- Colors ---
        const COLOR_PLAYER_SELF = getCssVar('--player-color') || 'red';
        // --- (Keep other color constants) ---
        const COLOR_PLAYER_OTHER = getCssVar('--other-player-color') || 'blue'; const COLOR_ENEMY = getCssVar('--enemy-color') || 'green'; const COLOR_BULLET_PLAYER = getCssVar('--bullet-player-color') || 'yellow'; const COLOR_BULLET_ENEMY = getCssVar('--bullet-enemy-color') || 'white'; const COLOR_NIGHT_OVERLAY = getCssVar('--night-overlay') || 'rgba(0, 0, 50, 0.4)'; const COLOR_TEXT = getCssVar('--text-color') || 'white'; const POWERUP_COLORS = {'health': getCssVar('--powerup-health') || 'lime','gun_upgrade': getCssVar('--powerup-gun') || 'fuchsia','speed_boost': getCssVar('--powerup-speed') || 'aqua','armor': getCssVar('--powerup-armor') || 'silver',};

        // --- DOM Elements ---
        const gameContainer = document.getElementById('game-container');
        // NEW Sections
        const modeSelectionSection = document.getElementById('mode-selection-section');
        const joinCodeSection = document.getElementById('join-code-section');
        const waitingSection = document.getElementById('waiting-section');
        const gameCodeDisplay = document.getElementById('game-code-display');
        const waitingMessage = document.getElementById('waiting-message');
        // Existing Sections/Elements
        const gameArea = document.getElementById('game-area');
        const gameOverScreen = document.getElementById('game-over-screen');
        const gameStatus = document.getElementById('game-status');
        const gameIdInput = document.getElementById('gameIdInput'); // Now used for joining
        const joinGameBtn = document.getElementById('joinGameBtn'); // Button in join section
        const canvas = document.getElementById('gameCanvas');
        const waitingCanvas = document.getElementById('waitingCanvas'); // Canvas for waiting screen
        const ctx = canvas.getContext('2d');
        const waitingCtx = waitingCanvas.getContext('2d'); // Context for waiting screen
        const playerStatsDiv = document.getElementById('player-stats');
        const gameInfoDiv = document.getElementById('game-info');
        const countdownDiv = document.getElementById('countdown');
        const dayNightIndicator = document.getElementById('day-night-indicator');
        const finalStatsDiv = document.getElementById('final-stats');
        const chatSection = document.getElementById('chat-section');
        const chatInput = document.getElementById('chatInput');
        const sendChatBtn = document.getElementById('sendChatBtn');
        const chatLog = document.getElementById('chat-log');
        // Buttons
        const playFriendBtn = document.getElementById('playFriendBtn');
        const showJoinCodeBtn = document.getElementById('showJoinCodeBtn');


        // --- Game State ---
        let socket;
        let gameState = null; // Full state from server { status: 'waiting'|'countdown'|'active'|'finished', ... }
        let localPlayerId = null;
        let currentGameId = null; // Store the current game ID locally
        let keys = {};
        let lastShotTime = 0;
        let animationFrameId = null;
        let playerMessages = {};

        // --- Utility ---
        function getCssVar(varName) {
            return getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
        }

        // --- UI Section Management ---
        function showSection(sectionId) {
             // Hide all main sections first
             modeSelectionSection.style.display = 'none';
             joinCodeSection.style.display = 'none';
             waitingSection.style.display = 'none';
             gameArea.style.display = 'none';
             gameOverScreen.style.display = 'none';

             // Show the requested section
             const sectionToShow = document.getElementById(sectionId);
             if (sectionToShow) {
                 sectionToShow.style.display = 'block'; // Or 'flex' if needed
             } else {
                 console.error("Tried to show non-existent section:", sectionId);
             }
             // Reset game status message unless specifically updated later
             // updateStatus(" ");
        }

        // --- WebSocket Logic ---
        function connectWebSocket(onOpenCallback) {
            // --- (Keep existing connectWebSocket function - checks state, sets handlers) ---
            if (socket && socket.readyState === WebSocket.OPEN) { console.warn("WS already open."); if(onOpenCallback) onOpenCallback(); return; }
            if (socket && socket.readyState === WebSocket.CONNECTING) { console.warn("WS already connecting."); return; }
            updateStatus('Connecting...');
            disableAllButtons(); // Disable buttons while connecting

            socket = new WebSocket(WEBSOCKET_URL);

            socket.onopen = () => {
                console.log('WebSocket connection established.');
                updateStatus('Connected.'); // Status: Connected
                enableModeSelectionButtons(); // Re-enable mode buttons on connect
                if (onOpenCallback) { onOpenCallback(); }
            };

            socket.onmessage = handleServerMessage;
            socket.onerror = (error) => { console.error('WebSocket Error:', error); updateStatus('Connection error. Please refresh.'); showErrorStateUI(); };
            socket.onclose = (event) => {
                console.log(`WebSocket Closed: Code=${event.code}, Reason=${event.reason}`);
                let message = 'Disconnected.';
                if (event.code !== 1000 && event.reason) { message += ` Reason: ${event.reason}`; }
                else if (event.code === 1006) { message = 'Connection lost. Please refresh.'; }
                updateStatus(message);
                showErrorStateUI();
                gameState = null; localPlayerId = null; currentGameId = null; playerMessages = {};
                if (animationFrameId) { cancelAnimationFrame(animationFrameId); animationFrameId = null; }
            };
        }

        function handleServerMessage(event) {
            // --- (Keep existing JSON parsing and error handling) ---
             try {
                 const data = JSON.parse(event.data);
                 console.debug("Message received:", data); // DEBUG

                 switch (data.type) {
                     case 'game_created':
                         localPlayerId = data.player_id;
                         currentGameId = data.game_id; // Store game ID
                         gameState = data.initial_state;
                         playerMessages = {};
                         gameCodeDisplay.textContent = currentGameId; // Show code
                         updateStatus(`Game created. Code: ${currentGameId}`);
                         showSection('waiting-section'); // Show waiting UI
                         addSystemMessageToLog(`Game ${currentGameId} created. Waiting for opponent...`);
                         // Optionally start drawing the waiting screen canvas
                         // drawWaitingScreen();
                         break;

                     case 'game_joined':
                         localPlayerId = data.player_id;
                         currentGameId = data.game_id; // Store game ID
                         gameState = data.initial_state;
                         playerMessages = {};
                         updateStatus(`Joined game: ${currentGameId}`);
                         showSection('game-area'); // Show main game area
                         // Server should now start countdown & send state updates
                         if (!animationFrameId) startGameLoop(); // Start loop if not running
                         addSystemMessageToLog(`Joined game ${currentGameId}. Get ready!`);
                         break;

                     case 'game_state':
                         const previousStatus = gameState ? gameState.status : null;
                         gameState = data.state; // Update local state
                         currentGameId = currentGameId || findMyGameId(); // Try to find game ID if missing

                         // --- Handle Transitions based on Status ---
                         if (gameState.status === 'waiting' && previousStatus !== 'waiting') {
                             // This might happen if host reconnects or state syncs weirdly
                             showSection('waiting-section');
                             gameCodeDisplay.textContent = currentGameId || '???';
                             updateStatus(`Waiting for opponent... Code: ${currentGameId || '???'}`);
                         } else if (gameState.status === 'countdown' && previousStatus === 'waiting') {
                             // Opponent joined, transition from waiting to countdown!
                             addSystemMessageToLog("Opponent joined! Countdown starting...");
                             showSection('game-area'); // Ensure game area is visible
                             if (!animationFrameId) startGameLoop(); // Ensure loop is running
                         } else if (gameState.status === 'active' && previousStatus === 'countdown') {
                              addSystemMessageToLog("Game active!");
                              // No UI section change needed here, just update normally
                         }

                         // Normal state update processing
                         if (gameState.status === 'active' || gameState.status === 'countdown' || gameState.status === 'waiting') {
                            updateUI(); // Update HUD, countdown etc. based on new state
                         }

                         if (gameState.game_over) {
                             showGameOver(); // Handle game over state
                         }
                         break;

                     case 'chat_message':
                          handleChatMessage(data.sender_id, data.message);
                          break;

                     case 'error':
                         console.error('Server Error:', data.message);
                         updateStatus(`Error: ${data.message}`);
                         // If game not found during join, reset to allow trying again
                         if (data.message.includes('Game not found') || data.message.includes('Game is full') || data.message.includes('not waiting')) {
                             showJoinUI(); // Go back to join input screen
                             enableJoinButton();
                         } else {
                             // For other errors, might go back to mode selection
                             // showModeSelection();
                             enableModeSelectionButtons();
                         }
                         break;

                     default:
                         console.warn('Unknown message type:', data.type);
                 }
             } catch (error) {
                 console.error('Error processing server message:', error, event.data);
             }
        }

        function sendMessage(payload) {
            // --- (Keep existing sendMessage function) ---
            if (socket && socket.readyState === WebSocket.OPEN) { socket.send(JSON.stringify(payload)); }
            else { console.error('Cannot send message, WS not open.'); updateStatus('Connection issue.'); showErrorStateUI(); }
        }

        // --- Game Actions ---
        function createFriendGame() { // Renamed from createGame
            updateStatus("Creating game...");
            disableAllButtons();
            connectWebSocket(() => { // Ensure connected before sending
                sendMessage({ type: 'create_game' });
            });
        }

        function joinGame() { // Now specifically joins using the code
            const gameId = gameIdInput.value.trim().toUpperCase();
            if (!gameId || gameId.length !== 6) {
                updateStatus('Please enter a valid 6-character Game ID.');
                gameIdInput.focus();
                return;
            }
            updateStatus(`Joining game ${gameId}...`);
            disableAllButtons();
            connectWebSocket(() => { // Ensure connected
                sendMessage({ type: 'join_game', game_id: gameId });
            });
        }

        function sendChatMessage() { /* Keep existing */ }

        // --- UI Management ---
        function updateStatus(message) { /* Keep existing */ }

        // --- NEW UI Show/Hide ---
        function showModeSelection() {
             showSection('mode-selection-section');
             updateStatus("Select a game mode.");
             enableModeSelectionButtons();
             gameIdInput.value = ''; // Clear join input
        }
        function showJoinUI() {
             showSection('join-code-section');
             updateStatus("Enter your friend's game code.");
             enableJoinButton();
             gameIdInput.focus();
        }

        // --- NEW Button Disabling/Enabling ---
        function disableAllButtons() {
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => button.disabled = true);
        }
        function enableModeSelectionButtons() {
             playFriendBtn.disabled = false;
             showJoinCodeBtn.disabled = false;
             // Keep others disabled until needed
             joinGameBtn.disabled = true;
             sendChatBtn.disabled = true; // Assume chat disabled initially
        }
         function enableJoinButton() {
             joinGameBtn.disabled = false;
             // Disable others
             playFriendBtn.disabled = true;
             showJoinCodeBtn.disabled = true;
             sendChatBtn.disabled = true;
         }
         function enableWaitingCancelButton() {
              const cancelBtn = waitingSection.querySelector('button');
              if (cancelBtn) cancelBtn.disabled = false;
              // Disable others
              playFriendBtn.disabled = true;
              showJoinCodeBtn.disabled = true;
              joinGameBtn.disabled = true;
              sendChatBtn.disabled = true;
         }
          function enableGamePlayButtons() {
               // Only enables chat send during gameplay for now
               sendChatBtn.disabled = false;
               // Leave game button?
               const leaveBtn = gameArea.querySelector('button'); // Assumes only one button for now
               if(leaveBtn) leaveBtn.disabled = false;
               // Disable mode selection etc.
               playFriendBtn.disabled = true;
              showJoinCodeBtn.disabled = true;
              joinGameBtn.disabled = true;
          }

        function showGameArea() { // Combined waiting/active game UI show
             showSection('game-area');
             enableGamePlayButtons();
             dayNightIndicator.style.display = 'block';
        }

        function showErrorStateUI() { // Reset UI on error/disconnect
             showModeSelection(); // Go back to mode select screen
             if (socket && socket.readyState !== WebSocket.CLOSED) { socket.close(); }
             socket = null;
             if (animationFrameId) { cancelAnimationFrame(animationFrameId); animationFrameId = null; }
        }

        function resetToConnection(closeSocket = true) { // Added flag to control socket close
             showModeSelection(); // Go back to mode selection
             updateStatus('Ready to start or join a game.');
             gameState = null; localPlayerId = null; currentGameId = null; playerMessages = {};
             chatLog.innerHTML = '';
             if (socket && closeSocket && socket.readyState === WebSocket.OPEN) {
                  socket.close(1000, "Returning to menu");
                  socket = null;
             } else if (!closeSocket && socket && socket.readyState !== WebSocket.OPEN) {
                  // If we chose not to close, but it's already closed/closing, clear ref
                  socket = null;
             }
             if (animationFrameId) { cancelAnimationFrame(animationFrameId); animationFrameId = null; }
        }

        function updateUI() { // Handles HUD, countdown etc based on gameState
            if (!gameState) return;

            // --- Update based on Status ---
            const player = gameState.players[localPlayerId];
            const isHost = localPlayerId === gameState.host_id;

             if(gameState.status === 'waiting') {
                waitingMessage.textContent = `Waiting for opponent... (${Object.keys(gameState.players).length}/${MAX_PLAYERS})`;
                // Update waiting canvas if needed
                // drawWaitingScreen();
                return; // Don't process active game UI updates yet
             }

            // --- Active or Countdown ---
            // Update HUD Stats
            if (player) {
                playerStatsDiv.innerHTML = `
                    <span>HP:</span> ${player.health}/${player.max_health}<br>
                    <span>Armor:</span> ${player.armor}<br>
                    <span>Gun:</span> ${player.gun}<br>
                    <span>Speed:</span> ${player.speed}<br>
                    <span>Kills:</span> ${player.kills} | <span>Score:</span> ${player.score}
                `;
            } else { playerStatsDiv.textContent = "Spectating? / Error"; }

            // Update Game Info
            gameInfoDiv.innerHTML = `Score: ${gameState.score} | Level: ${gameState.level}`;

            // Update Countdown Timer
            if (gameState.status === 'countdown' && gameState.countdown >= 0) {
                countdownDiv.textContent = Math.ceil(gameState.countdown);
                countdownDiv.style.display = 'block';
                dayNightIndicator.style.display = 'none';
            } else {
                countdownDiv.style.display = 'none';
                dayNightIndicator.style.display = 'block';
            }

            // Update Day/Night Indicator Text & Canvas Background
            const isNight = gameState.is_night;
            dayNightIndicator.textContent = isNight ? 'Night' : 'Day';
            canvas.style.backgroundColor = isNight ? getCssVar('--bg-color') : '#A0522D'; // Use bg-color for night?
        }

        function showGameOver() { /* Keep existing */ }
        function handleChatMessage(senderId, message) { /* Keep existing */ }
        function addMessageToLog(sender, message, isSelf) { /* Keep existing */ }
        function addSystemMessageToLog(message) { /* Keep existing */ }

        // --- Game Loop and Drawing ---
        function setupGameControls() { /* Keep existing */ }
        function removeGameControls() { /* Keep existing */ }
        function handleKeyDown(e) { /* Keep existing, check gameState.status === 'active' */
            if (document.activeElement === chatInput) return;
            // Only allow movement/shooting if game is active
            if (gameState && gameState.status === 'active' && !gameState.game_over) {
                 keys[e.key.toLowerCase()] = true;
            }
        }
        function handleKeyUp(e) { /* Keep existing */ }
        function handleChatEnter(e) { /* Keep existing */ }
        function handlePlayerMovement() { /* Keep existing, maybe add status check? */
            if (gameState && gameState.status !== 'active') return; // Only move when active
            // ... rest of movement logic ...
        }
        function handleShooting() { /* Keep existing, maybe add status check? */
            if (gameState && gameState.status !== 'active') return; // Only shoot when active
            // ... rest of shooting logic ...
        }

        function startGameLoop() {
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            setupGameControls();
            function gameLoop() {
                 if (!gameState || gameState.game_over) {
                     removeGameControls(); animationFrameId = null; return;
                 }
                 // Only run input/drawing if NOT waiting
                 if (gameState.status === 'active' || gameState.status === 'countdown') {
                    handlePlayerMovement();
                    handleShooting();
                    drawGame(); // Draw the main game canvas
                 } else if (gameState.status === 'waiting') {
                     // Optionally draw a simplified waiting screen on the waitingCanvas
                     // drawWaitingScreen();
                 }
                 animationFrameId = requestAnimationFrame(gameLoop);
            }
            animationFrameId = requestAnimationFrame(gameLoop);
        }

        // --- Drawing Functions --- (Keep drawGame, drawHealthBar, drawPlayerChatMessage)
        function drawGame() { /* Keep existing - draws on main canvas */ }
        function drawHealthBar(ctx, x, y, width, currentHealth, maxHealth) { /* Keep existing */ }
        function drawPlayerChatMessage(ctx, player, playerId) { /* Keep existing */ }

        // --- NEW: Helper to find game ID from state if needed ---
        function findMyGameId() {
             // This is tricky if not received directly. Could try iterating gameState.players?
             // For now, rely on currentGameId being set correctly on create/join.
             return null;
        }


        // --- Initialization ---
        window.onload = () => {
             showModeSelection(); // Start at the mode selection screen
             connectWebSocket(); // Connect automatically on load
             // updateStatus("Ready to play!"); // Status updated by connectWebSocket
        };

    </script>
</body>
</html>
